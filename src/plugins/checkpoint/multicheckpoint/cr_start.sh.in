#!/bin/sh

source /etc/profile
DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
source $DIR/cr_common.sh

#############################################
##############################################
####  START JOB WITH CHECKPOINT SUPPORT ######

#Auxiliary functions. Each one initializes a job using a certain checkpoint lib
startBLCRCheckpointedJob(){
  exec $@
  return 0
}

#TODO MANUEL: VER Q ESTO VALE PARA VARIOS TRABAJOS EN EL MISMO NODO!
startDMTCPCheckpointedJob(){
  #start coordinator
  dmtcp_coordinator --daemon --exit-on-last --ckptdir $checkpoint_folder  #this dir will be created prior to checkpoint request
  if [ $? -ne 0 ]
  then
    echo "A coordinator was already running"
  fi

  #start app joining that coordinator
  #TODO MANUEL: ESTO SOLO VALE PARA SERIAL. PARA PARALELO HACE FALTA DEBUG, ESTA EN ACME
   exec dmtcp_launch --ib --rm --ckptdir $checkpoint_folder $@
  return 0
}
startCRIUCheckpointedJob(){
  exec $@
  return 0
}


#This is the main function
#$1: name of the checkpoint library to use
#returns: 0 on success, other if not
startCheckpointedJob(){
  if [ "$1" == "BLCR" ]
  then
    startBLCRCheckpointedJob $2
    return 0
  elif [ "$1" == "DMTCP" ]
  then
    startDMTCPCheckpointedJob $2
    return 0
  elif [ "$1" == "CRIU" ]
  then
    startCRIUCheckpointedJob $2
    return 0
  fi
  return 1
}


#############################################
##############################################
####  MAIN: we start here ######

#see who is the first task
checkpoint_folder=$SLURM_CHECKPOINT_IMAGE_DIR/$SLURM_JOB_ID
if ! semaphore $checkpoint_folder ;
then
  #this is not the first task
  exit 0
fi

#see which checkpoint library we will be using
checkpointLib=`whichCheckpointLib`

#start job with this checkpoint lib
startCheckpointedJob $checkpointLib $@
exit 0
