#!/bin/sh

#### PROBLEM WITH SOME MERGE. WILL FAIL FOR SURE.

source /etc/profile
DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
source $DIR/cr_common.sh

#input parameters:
#$1: slurm_job_id
#$2: jobPID
#$3: contextFile
#$5: full job name

#############################################
##############################################
####  CHECKPOINT JOB ######

#Auxiliary functions. Each one creates a checkpoint with a certain lib
checkpointBLCRJob(){
  cd $checkpointDir
  cr_checkpoint -T $jobPID -f $contextFile
  return 0
}

<<<<<<< HEAD
checkpointDMTCPJob(){

  SLURM_CHECKPOINT_IMAGE_DIR=`dirname $checkpoint_folder`
  checkpoint_info=$SLURM_CHECKPOINT_IMAGE_DIR"/checkpoint_info."$SLURM_JOB_ID

  source $checkpoint_info
  cd $checkpoint_folder
=======
#TODO MANUEL: VER QUE PASA CON LA CONCURRENCIA AQUI
checkpointDMTCPJob(){
  cd $checkpointDir
>>>>>>> migration
  dmtcp_command  bc
  return 0
}

checkpointCRIUJob(){
<<<<<<< HEAD
  cp -u $fullJobName $checkpoint_folder"/inputScript.sh"
  sudo criu dump -vvvv -o $checkpoint_folder/checkpoint_create.log --shell-job -D $checkpoint_folder --leave-running -t $jobPID
=======
  cp -u $fullJobName $checkpointDir"/inputScript.sh"
  sudo criu dump -vvvv -o $checkpointDir/checkpoint_create.log --shell-job -D $checkpointDir --leave-running -t $jobPID
>>>>>>> migration
  return 0
}


#This is the main function
#$1: name of the checkpoint library to use
#returns: 0 on success, other if not
checkpointJob(){
  if [ "$1" == "BLCR" ]
  then
    checkpointBLCRJob $@
    return 0
  elif [ "$1" == "DMTCP" ]
  then
    checkpointDMTCPJob $@
    return 0
  elif [ "$1" == "CRIU" ]
  then
    checkpointCRIUJob $@
    return 0
  fi
  return 1
}


#############################################
##############################################
####  MAIN: we start here ######

<<<<<<< HEAD
SLURM_JOB_ID=$1
jobPID=$2
contextFile=$3
checkpoint_folder=`dirname $contextFile`
fullJobName=$4

mkdir -p $checkpoint_folder

checkpointLib=`whichCheckpointLib`

echo "$checkpointLib" >> $checkpoint_folder"/checkpoint_library"
=======
slurm_job_id=$1
jobPID=$2
contextFile=$3
checkpointDir=`dirname $contextFile`
fullJobName=$4

checkpointLib=`whichCheckpointLib`

mkdir $checkpointDir

echo $checkpointLib > $checkpointDir"/checkpoint_library"
>>>>>>> migration

checkpointJob $checkpointLib

exit 0
