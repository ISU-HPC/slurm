#!/bin/sh

source /etc/profile
DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
source $DIR/cr_common.sh


#jiajun
export PATH=/home/dmtcpuser/dmtcp/bin:$PATH
export LD_LIBRARY_PATH=/home/dmtcpuser/dmtcp/lib/dmtcp:$LD_LIBRARY_PATH



export SLURM_CHECKPOINT_IMAGE_DIR=$1
export SLURM_JOB_ID=$2
export SLURM_JOB_NODELIST=$3
export SLURM_TASKS_PER_NODE=$4
export SLURM_JOB_CPUS_PER_NODE=$5
#export SLURM_LOCALID=$6
export SLURM_SRUN_COMM_HOST=$7
export SLURM_NNODES=$8
export TMPDIR=$9


#here we will store information about checkpoint
checkpoint_info=$SLURM_CHECKPOINT_IMAGE_DIR"/checkpoint_info."$SLURM_JOB_ID
checkpoint_folder=$SLURM_CHECKPOINT_IMAGE_DIR"/"$SLURM_JOB_ID

#see who is the first task
if ! semaphore $SLURM_CHECKPOINT_IMAGE_DIR $SLURM_JOB_ID;
then
  #this is not the first task
  exit 0
fi

startDMTCPCoordinator $checkpoint_folder $checkpoint_info

#checkpoint info is created in startDMTCPCoordinator function. It is different that in "cr_start", where it is created in the "sempahore" function
trap 'rm -rf $checkpoint_info' SIGHUP SIGINT SIGTERM EXIT

#restart job
/bin/bash $checkpoint_folder/dmtcp_restart_script.sh

#clean tmp files after a successful execution
rm -rf $SLURM_CHECKPOINT_IMAGE_DIR/$SLURM_JOB_ID.ckpt
rm -rf $checkpoint_folder
